# 表格比对工具 (Compare Tables V2)

这是一个用于比对 **扫描数据表 (Table A)** 与 **包裹清单表 (Table B)** 的自动化 Python 脚本。
该工具支持批量处理、特殊的条码解码逻辑、以及生成带有颜色标记的比对结果和回填文件。

## 功能特性

*   **自动批量处理**：支持指定文件夹，自动合并文件夹内所有的扫描文件，并批量处理包裹清单文件。
*   **智能条码匹配**：
    *   支持多种条码编码格式解析（Base36 转换、ASCII 解码等）。
    *   **一对多匹配支持**：如果包裹清单中的一行对应扫描数据中的多行（例如多次扫描），脚本会展开显示所有匹配的扫描记录，避免数据丢失。
*   **可视化结果导出**：
    *   生成包含详细比对信息的 Excel 文件。
    *   **颜色标记**：
        *   🟢 **绿色**：完全匹配（箱号和渠道号均一致）。
        *   🟡 **黄色**：部分匹配（箱号或渠道号不一致）。
        *   🔴 **红色**：未匹配到条码。
        *   🟠 **橙色**：发现重复的原始扫描序号（可能提示数据异常）。
*   **原有格式回填**：生成 `回填结果_*.xlsx`，直接在原始包裹清单的格式上填充扫描到的实际数据（实际扫描号、破损信息等）。

## 环境要求

需要安装 Python 3 以及以下依赖库：

```bash
pip install pandas openpyxl
```

## 使用方法

脚本可以在命令行中直接运行。

### 1. 默认模式（批量处理）

默认会读取当前目录下 `compare_tables_test/input_scan` 中的所有扫描文件，与 `compare_tables_test/input_pkg` 中的所有包裹文件进行比对。

```bash
python compare_table_v2.py
```

### 2. 指定文件或文件夹

你可以手动指定输入文件或文件夹路径。

**语法**：
```bash
python compare_table_v2.py [扫描数据路径] [包裹清单路径]
```

**示例**：

*   **单文件模式**：比对特定的两个文件。
    ```bash
    python compare_table_v2.py ./scan_data.xlsx ./package_list.xlsx
    ```

*   **混合模式**：使用一个文件夹的扫描数据（自动合并）去比对单个包裹清单。
    ```bash
    python compare_table_v2.py ./input_scan_dir ./package_list.xlsx
    ```

## 输入文件说明

### 1. 扫描数据表 (Table A)
脚本会自动识别和处理以下列（或包含相关信息的列）：
*   **条码** / **原始扫描序号**：用于解码和匹配的原始数据。
*   **箱号**：用于核对。
*   **渠道号**：用于核对。

### 2. 包裹清单表 (Table B)
支持包含多个渠道分组的复杂表头格式。脚本会自动识别以下关键列：
*   **预报单号**
*   **托盘序号**
*   **出库Ref**
*   **破损/不可识别**
*   （可选）**包裹列表** Sheet：用于卡派渠道的预报单号到跟踪号的映射替换。

## 输出文件

结果文件将生成在 `compare_tables_test/output/` 目录下（或根据脚本逻辑生成的目录）：

1.  **比较结果_文件名.xlsx**：
    *   包含标准化的数据列，用于详细核查。
    *   应用了红/黄/绿/橙颜色标记。

2.  **回填结果_文件名.xlsx**：
    *   保留了原始 Excel 文件的格式。
    *   在对应的单元格中回填了“实际扫描”和“破损/不可识别”数据，并填充了相应的背景色。

## 注意事项

*   **文件名编码**：脚本已优化对特殊字符文件名的支持。
*   **重复处理**：V2 版本修复了旧版本可能存在的“单行覆盖”问题。如果在结果中看到橙色标记，说明该扫描序号确实在数据中出现了多次（或者是有效的重复匹配）。
*   **颜色错位修复**：V2 版本包含 `reset_index` 修复，确保 Excel 导出时的颜色行号与数据严格对应。
